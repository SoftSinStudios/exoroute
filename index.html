<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' blob:; script-src 'self' 'unsafe-inline'; object-src 'none'; base-uri 'none'; frame-ancestors 'none'; img-src 'self' data:; style-src 'self' 'unsafe-inline'">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ED SW CSV Tool</title>
<style>
  :root {
    --bg: #0f1116;
    --panel: #141824;
    --ink: #e6eaf2;
    --mut: #9aa3b2;
    --accent: #ff4d6d;
    --accent-2: #7aa2f7;
    --line: #23283a;
    --dot-icy: #76b5ff;
    --dot-rocky-ice: #aad4ff;
    --dot-rocky: #cfa87a;
    --dot-metal: #ffd37a;
    --good: #62d69a;
    --warn: #ffd56a;
    --bad: #ff6b6b;
  }

  * {
    box-sizing: border-box;
  }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: radial-gradient(circle at top, #181c2a 0, #05060a 60%);
    color: var(--ink);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  body {
    display: block;
	
  }

  #appWrap {
    display: block;
    min-width: 1080px;
	width: 1080px;
	margin: 0 auto;
  }

  .wrap {
    max-width: auto;
    margin: 32px auto;
    padding: 0 16px;
  }

  header {
    margin-bottom: 16px;
  }

  h1 {
    margin: 0 0 8px;
    font-size: 20px;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  h1 .hl {
    display: inline-block;
    width: 72px;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    border-radius: 999px;
  }

  header .sub {
    font-size: 13px;
    color: var(--mut);
  }

  header .sub b {
    color: var(--ink);
  }

  header .sub a {
    color: var(--accent-2);
    text-decoration: none;
  }

  header .sub a:hover {
    text-decoration: underline;
  }

  .legend {
    margin: 16px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 12px 24px;
    font-size: 13px;
    color: var(--mut);
  }

  .legend .item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .legend .dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }
  
  .dot {
	width: 12px;
	height: 12px;
	border-radius: 50%;
	display: inline-block;
	margin-right: 4px;
  }

  .dot-icy {
    background: var(--dot-icy);
  }

  .dot-rocky-ice {
    background: var(--dot-rocky-ice);
  }

  .dot-rocky {
    background: var(--dot-rocky);
  }

  .dot-metal {
    background: var(--dot-metal);
  }

  #io-controls button {
    background: #1d2233;
    border: 1px solid var(--line);
    color: var(--ink);
    font-size: 13px;
    padding: 6px 10px;
    cursor: pointer;
    border-radius: 4px;
  }

  #io-controls button:hover {
    border-color: var(--accent-2);
  }

  #io-controls {
    display: flex;
    gap: 8px;
  }

  .table-wrap {
    margin-top: 16px;
    background: rgba(10, 12, 20, 0.9);
    border-radius: 8px;
    border: 1px solid #20263a;
    padding: 10px 12px;
    margin: 0;
    border-bottom: 1px solid var(--line);
  }

  .stats {
    display: flex;
    flex-wrap: wrap;
    gap: 12px 24px;
    margin-bottom: 12px;
    font-size: 13px;
  }

  .stats .stat {
    display: flex;
    align-items: baseline;
    gap: 4px;
  }

  .stats .k {
    color: var(--mut);
  }

  .stats .v {
    font-weight: 500;
  }

  .stats .v.good {
    color: var(--good);
  }

  .stats .v.warn {
    color: var(--warn);
  }

  .stats .v.bad {
    color: var(--bad);
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead th {
    position: sticky;
    top: 0;
    background: linear-gradient(180deg, #1c2232 0, #151927 60%);
    color: var(--mut);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 8px 6px;
    border-bottom: 1px solid #262c40;
    white-space: nowrap;
  }

  thead th:first-child {
    border-top-left-radius: 6px;
  }

  thead th:last-child {
    border-top-right-radius: 6px;
  }

  tbody td {
    padding: 6px 6px;
    font-size: 13px;
    border-bottom: 1px solid #1b2031;
    white-space: nowrap;
  }

  tbody tr:nth-child(even) {
    background: #151827;
  }

  tbody tr:nth-child(odd) {
    background: #101321;
  }

  tbody tr:hover {
    background: #1a1f32;
  }

  tbody td:first-child {
    position: sticky;
    left: 0;
    background: inherit;
  }

  tbody td:nth-child(2) {
    position: left;
    left: 60px;
    background: inherit;
  }
  
  td:nth-child(8) {
    text-align: center;
  }

  td:nth-child(7) {
    text-align: center;
}

  .system-name {
    font-weight: 500;
    color: var(--ink);
  }

  .body-name {
    color: var(--mut);
  }

  .value-col {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .center {
    text-align: center;
  }

  .checkbox-cell input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }
  
  .body-type-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 4px;
  }

  .body-type-label {
    font-size: 12px;
    color: var(--mut);
  }

  .body-type-icy {
    background: var(--dot-icy);
  }

  .body-type-rocky-ice {
    background: var(--dot-rocky-ice);
  }

  .body-type-rocky {
    background: var(--dot-rocky);
  }

  .body-type-metal {
    background: var(--dot-metal);
  }

  /* struck row styling */
  .row-struck td:not(:first-child) {
  text-decoration: line-through;
  text-decoration-thickness: 14px;
  text-decoration-color: rgba(70, 100, 70, 0.65); /* faded line */
  /* no opacity here */
}

  .row-struck td.center {
    opacity: 0.5;
  }

  footer {
    margin-top: 12px;
    font-size: 12px;
    color: var(--mut);
  }

  @media (max-width: 900px) {
    h1 {
      font-size: 18px;
      flex-wrap: wrap;
    }
    .legend {
      flex-direction: column;
      align-items: flex-start;
    }
    .stats {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
</head>
<body>

<div id="appWrap">
<div class="wrap">
<header>
<h1>Storm Walkers Exobiology Run CSV Reader and Exporter <span class="hl"></span></h1>
<div class="sub">Import an <b>EXO MASTERY ROUTE</b> CSV from <a href="https://spansh.co.uk/" target="_blank" rel="noreferrer">Spansh.co.uk</a>,
 instantly convert it into a clear HTML route viewer, and export it as a
 local HTML file you can keep and reopen whenever you need. </div>
<div class="legend">
  <div class="item" id="io-script">
    <button id="btn-import-csv" type="button">Import CSV</button>
    <input id="file-csv" type="file" accept=".csv" style="display:none">
    <button id="btn-export-html" type="button">Export HTML</button>
  </div>
  <div class="legend legendhelpers">
	  <div class="item">Distance To Arrival: light seconds</div>
	  <div class="item">Jumps: Number of Jumps From Current Location</div>
	  <div class="item">Count: Number of all Biological Signs</div>
	  <div class="item">Value: Most lucrative Sample, Per Location</div>
  </div>
 </div>
</header>
<div class="table-wrap">
    <div class="stats">
    <div class="stat"><span class="k">Systems:</span> <span class="v" id="stat-systems">0</span></div>
    <div class="stat"><span class="k">Bodies:</span> <span class="v" id="stat-bodies">0</span></div>
    <div class="stat"><span class="k">Jumps:</span> <span class="v" id="stat-jumps">0</span></div>
    <div class="stat"><span class="k">Biologicals:</span> <span class="v" id="stat-bios">0</span></div>
    <div class="stat"><span class="k">Potential CR:</span> <span class="v" id="stat-value">0</span></div>
    <div class="stat"><span class="k">Scanned CR:</span> <span class="v" id="stat-scanned">0</span></div>
    <div class="stat"><span class="k">Remaining CR:</span> <span class="v" id="stat-remaining">0</span></div>
  </div>
   
  <div class="stats bodytype-row">
    <div class="stat">
      <span class="body-type-dot body-type-icy"></span><span class="body-type-label">I W</span>
    </div>
    <div class="stat">
      <span class="body-type-dot body-type-rocky-ice"></span><span class="body-type-label">R I W</span>
    </div>
    <div class="stat">
      <span class="body-type-dot body-type-rocky"></span><span class="body-type-label">R W</span>
    </div>
    <div class="stat">
      <span class="body-type-dot body-type-metal"></span><span class="body-type-label">H M C W</span>
    </div>
  </div>
  
  <div class="table-wrap-inner" style="overflow-x:auto;">
    <table>
      <thead>
        <tr>
          <th class="center">Done</th>
          <th style="text-align:left;" title="Field #1">System Name</th>
          <th style="text-align:left;" title="Field #2">Body Name</th>
          <th style="text-align:left;" title="Field #3">Distance To Arrival</th>
          <th style="text-align:left;" title="Field #4">Landmark Subtype</th>
          <th style="text-align:left;" title="Field #5">Value</th>
          <th style="text-align:left;" title="Field #6">Count</th>
          <th style="text-align:left;" title="Field #7">Jumps</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<footer>
  Built for quick sharing. Import your .CSV and export in HTML format for offline use.
</footer>
</div>
<script id="io-script">
(function(){
  var btnImport = document.getElementById('btn-import-csv');
  var fileInput = document.getElementById('file-csv');
  var btnExport = document.getElementById('btn-export-html');
  var table = document.querySelector('table');
  if (!table) return;
  var tbody = table.tBodies && table.tBodies[0];

  function stripOuterQuotes(s){
    if (s == null) return "";
    s = String(s);
    s = s.trim();
    if ((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))) {
      var q = s[0];
      s = s.slice(1, -1);
      if (q === '"') s = s.replace(/""/g, '"');
      if (q === "'") s = s.replace(/''/g, "'");
    }
    return s;
  }

  // lightweight CSV parser that handles quoted fields and commas inside quotes
  function parseCSV(text){
    var rows = [];
    var i = 0, field = "", row = [], inQuotes = false, qchar = null;
    while (i < text.length) {
      var c = text[i];
      if (inQuotes) {
        if (c === qchar) {
          if (text[i+1] === qchar) {
            field += qchar; i += 2; continue;
          } else {
            inQuotes = false; i++; continue;
          }
        } else {
          field += c; i++; continue;
        }
      } else {
        if (c === '"' || c === "'") {
          inQuotes = true; qchar = c; i++; continue;
        }
        if (c === ',') { row.push(stripOuterQuotes(field)); field = ""; i++; continue; }
        if (c === '\r') { i++; continue; }
        if (c === '\n') { row.push(stripOuterQuotes(field)); rows.push(row); row = []; field = ""; i++; continue; }
        field += c; i++; continue;
      }
    }
    row.push(stripOuterQuotes(field));
    rows.push(row);
    return rows.filter(function(r){ return r.length && r.join('').trim().length; });
  }

  function importCSV(text){
	  if (!tbody) return;
	  var rows = parseCSV(text);
	  // if header row looks like ours, skip it
	  if (rows.length && /system\s*name/i.test(rows[0][0] || "")) {
		rows = rows.slice(1);
	  }
	  var frag = document.createDocumentFragment();
	  rows.forEach(function(cols){
		var tr = document.createElement('tr');
		tr.dataset.subtype = stripOuterQuotes(cols[2] || "");

		// checkbox cell
		var tdCheck = document.createElement('td');
		var cb = document.createElement('input');
		cb.type = 'checkbox';
		cb.className = 'scan-checkbox';
		tdCheck.appendChild(cb);
		tr.appendChild(tdCheck);

		// explicit cells so we can force Count = 1
		var td;

		// System Name (CSV col 0)
		td = document.createElement('td');
		td.textContent = stripOuterQuotes(cols[0] || "");
		tr.appendChild(td);

		// Body Name (CSV col 1)
		td = document.createElement('td');
		td.textContent = stripOuterQuotes(cols[1] || "");
		tr.appendChild(td);

		// Distance To Arrival (CSV col 3)
		td = document.createElement('td');
		td.textContent = stripOuterQuotes(cols[3] || "");
		tr.appendChild(td);

		// Landmark Subtype (CSV col 4)
		td = document.createElement('td');
		td.textContent = stripOuterQuotes(cols[4] || "");
		tr.appendChild(td);

		// Value (CSV col 5)
		td = document.createElement('td');
		td.textContent = stripOuterQuotes(cols[5] || "");
		tr.appendChild(td);

		// Count â€” ALWAYS 1, regardless of CSV
		td = document.createElement('td');
		td.textContent = "1";
		tr.appendChild(td);

		// Jumps (CSV col 7)
		td = document.createElement('td');
		td.textContent = stripOuterQuotes(cols[7] || "");
		tr.appendChild(td);

		frag.appendChild(tr);
	  });
	  tbody.innerHTML = "";
	  tbody.appendChild(frag);
	  applyDots();
	  updateStats();
	}


  if (btnImport && fileInput) {
    btnImport.addEventListener('click', function(){ fileInput.click(); });
    fileInput.addEventListener('change', function(){
      var f = fileInput.files && fileInput.files[0];
      if (!f) return;
      var reader = new FileReader();
      reader.onload = function(e){ importCSV(e.target.result || ""); };
      reader.readAsText(f);
      fileInput.value = '';
    });
  }

  if (btnExport) {
    btnExport.addEventListener('click', function(){
      var name = prompt('Choose a file name (without extension):', 'exo-run-export');
      if (name == null) return;
      name = String(name).trim().replace(/[\\/:*?"<>|]+/g, '_');
      if (!name) name = 'exo-run-export';
      if (!/\.html?$/i.test(name)) name += '.html';
      var blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      a.click();
      URL.revokeObjectURL(a.href);
    });
  }

  // map body subtype text to a color
  function dotColorFor(subtypeText){
    var t = String(subtypeText || '').toLowerCase();

    // rocky ice world first so it does not get caught by plain "rocky"
    if (t.includes('rocky ice'))   return 'rgb(95, 173, 224)';   // Rocky Ice World
    if (t.includes('icy'))         return '#ADD8E6';             // Ice World
    if (t.includes('rocky'))       return 'rgb(140, 90, 50)';    // Rocky World
    if (t.includes('high metal'))  return 'rgb(170, 140, 60)';   // High Metal World
    if (t.includes('metal-rich'))  return 'rgb(170, 140, 60)';   // Metal-rich body

    return '';
  }

  // add a color dot before Body Name
  function applyDots(){
    var table = document.querySelector('table');
    if (!table || !table.tBodies.length) return;
    var tbody = table.tBodies[0];
    Array.from(tbody.rows).forEach(function(r){
      var bodyNameCell = r.cells[2]; // Body Name (after checkbox and system)
      var subtype = r.dataset.subtype;
      var color = dotColorFor(subtype);
      if (color && !bodyNameCell.querySelector('.dot')) {
        var dot = document.createElement('span');
        dot.className = 'dot';
        dot.style.background = color;
        bodyNameCell.prepend(dot);
      }
    });
  }

  function numberify(txt){
    if (txt == null) return 0;
    var s = String(txt).replace(/,/g,'').trim();
    var n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  function setRowStruck(tr, on){
    if (!tr) return;
    if (on) {
      tr.classList.add('row-struck');
    } else {
      tr.classList.remove('row-struck');
    }
  }

  function updateStats(){
    var table = document.querySelector('table');
    if (!table || !table.tBodies.length) return;
    var tbody = table.tBodies[0];
    var rows = Array.from(tbody.rows);
    var systems = [];
    var bodies = 0;
    var sumCount = 0;
    var sumValueTimesCount = 0;
    var jumps = 0;
    var scannedSum = 0;

    rows.forEach(function(r){
      var c = r.cells;
      if (c.length < 8) return;
      var sys = (c[1].textContent || '').trim(); // system name after checkbox
      systems.push(sys);
      bodies += 1;
      var val = numberify(c[5].textContent); // Value
      var cnt = numberify(c[6].textContent); // Count
      var rowJumps = numberify(c[7].textContent); // Jumps
      sumCount += cnt;
      sumValueTimesCount += val * cnt;
      jumps += rowJumps;

      var cb = r.querySelector('.scan-checkbox');
      if (cb && cb.checked) {
        scannedSum += val * cnt;
      }
    });

    var uniqueSystems = Array.from(new Set(systems)).length;

    var fmt = new Intl.NumberFormat();
    var el = function(id){ return document.getElementById(id); };

    var total   = Math.round(sumValueTimesCount);
    var scanned = Math.round(scannedSum);
    var remain  = total - scanned;

    if (el('stat-systems'))    el('stat-systems').textContent    = fmt.format(uniqueSystems);
    if (el('stat-bodies'))     el('stat-bodies').textContent     = fmt.format(bodies);
    if (el('stat-jumps'))      el('stat-jumps').textContent      = fmt.format(jumps);
    if (el('stat-bios'))       el('stat-bios').textContent       = fmt.format(sumCount);
    if (el('stat-value'))      el('stat-value').textContent      = fmt.format(total);
    if (el('stat-scanned'))    el('stat-scanned').textContent    = fmt.format(scanned);
    if (el('stat-remaining'))  el('stat-remaining').textContent  = fmt.format(remain);
  }

  // delegate checkbox changes
  if (tbody) {
    tbody.addEventListener('change', function(e){
      var t = e.target;
      if (t && t.classList.contains('scan-checkbox')) {
        var tr = t.closest('tr');
        setRowStruck(tr, t.checked);
        updateStats();
      }
    });
  }

  updateStats();
})();
</script>
</body></html>
